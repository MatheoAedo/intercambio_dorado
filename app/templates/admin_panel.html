{% extends "home.html" %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-3">Panel de Administración - Usuarios</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>Edad</th>
          <th>Ubicación</th>
          <th>Créditos</th>
          <th>Rol</th>
          <th style="width: 360px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.nombre }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.edad }}</td>
          <td>{{ u.ubicacion }}</td>
          <td>{{ u.creditos }}</td>
          <td><span class="badge bg-secondary">{{ u.rol }}</span></td>
          <td>
            <!-- Botón mostrar/ocultar edición -->
            <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#edit-{{ u.id }}">
              Editar
            </button>

            <!-- Botón mostrar/ocultar cambio contraseña -->
            <button class="btn btn-sm btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#pass-{{ u.id }}">
              Cambiar clave
            </button>

            <!-- Eliminar -->
            <a class="btn btn-sm btn-danger"
               href="{{ url_for('admin_user_delete', id=u.id) }}"
               onclick="return confirm('¿Seguro que deseas eliminar este usuario?');">
              Eliminar
            </a>

            <!-- Form edición -->
            <div class="collapse mt-2" id="edit-{{ u.id }}">
              <div class="card card-body">
                <form method="POST" action="{{ url_for('admin_user_edit', id=u.id) }}">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input class="form-control" name="nombre" value="{{ u.nombre }}" required minlength="3" maxlength="100">
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Ubicación</label>
                    <input class="form-control" name="ubicacion" value="{{ u.ubicacion }}" required minlength="2" maxlength="100">
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Créditos</label>
                    <input class="form-control" type="number" name="creditos" value="{{ u.creditos }}" min="0" step="1" required>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Rol</label>
                    <select class="form-select" name="rol" required>
                      <option value="usuario" {% if u.rol == 'usuario' %}selected{% endif %}>usuario</option>
                      <option value="admin" {% if u.rol == 'admin' %}selected{% endif %}>admin</option>
                    </select>
                  </div>

                  <button class="btn btn-success btn-sm" type="submit">
                    Guardar cambios
                  </button>
                </form>
              </div>
            </div>

            <!-- Form cambio contraseña -->
            <div class="collapse mt-2" id="pass-{{ u.id }}">
              <div class="card card-body">
                <form method="POST" action="{{ url_for('admin_user_password', id=u.id) }}">
                  <div class="mb-2">
                    <label class="form-label">Nueva contraseña</label>
                    <input class="form-control" type="password" name="password" required minlength="6">
                    <small class="text-muted">Mínimo 6 caracteres.</small>
                  </div>
                  <button class="btn btn-success btn-sm" type="submit">
                    Actualizar clave
                  </button>
                </form>
              </div>
            </div>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Volver al Dashboard</a>
  </div>
</div>

{% endblock %}
